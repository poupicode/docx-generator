<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <title>Générateur de Rapport DOCX</title>
</head>

<body>
    <h2>Générateur de Rapport de Téléconsultation</h2>

    <label>Template Word (.docx) :</label>
    <input type="file" id="docxTemplate" /><br /><br />

    <label>Données JSON :</label>
    <input type="file" id="jsonData" /><br /><br />

    <button id="generateBtn">Générer le rapport</button>

    <script type="module">
        import { createReport } from 'https://unpkg.com/docx-templates/lib/browser.js';

        const readFileAsArrayBuffer = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onerror = reject;
                reader.onload = () => resolve(reader.result);
                reader.readAsArrayBuffer(file);
            });
        };

        const readFileAsText = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onerror = reject;
                reader.onload = () => resolve(reader.result);
                reader.readAsText(file);
            });
        };

        document.getElementById('generateBtn').addEventListener('click', async () => {
            const templateInput = document.getElementById('docxTemplate');
            const jsonInput = document.getElementById('jsonData');

            if (!templateInput.files.length || !jsonInput.files.length) {
                alert("Merci de fournir le template DOCX et le fichier JSON.");
                return;
            }

            const templateFile = templateInput.files[0];
            const jsonFile = jsonInput.files[0];

            const [template, jsonText] = await Promise.all([
                readFileAsArrayBuffer(templateFile),
                readFileAsText(jsonFile),
            ]);

            const data = JSON.parse(jsonText);

            const report = await createReport({
                template,
                data,
                noSandbox: true,
                cmdDelimiter: ['{', '}'],
            });

            const blob = new Blob([report], {
                type: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
            });

            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'rapport.docx';
            link.click();
        });
    </script>
</body>

</html>